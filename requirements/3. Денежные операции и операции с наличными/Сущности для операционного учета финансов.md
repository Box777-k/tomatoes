# Сущности для операционного учета финансов

Документ описывает сущности для реализации use-case операционного учета финансов согласно архитектуре контекстов.

## Текущее состояние

### Entities (существуют)
- OperationalAccountEntity - операционные счета организации
- OperationalTransactionEntity - операционные финансовые операции

### Enums (существуют)
- AccountType - типы счетов (BANK, CASH, OTHER)
- TransactionType - типы операций (INCOME, EXPENSE)

### Модуль finance
- models.py - пусто
- schemas.py - пусто
- repositories.py - пусто
- services.py - не проверялось

## Анализ недостающих компонентов

### 1. Entity: OperationalAccountEntity
Существующая сущность покрывает базовые потребности, но требует доработки:
- Поле balance (начальный остаток) - недостаточно для отслеживания текущего баланса
- Отсутствует признак is_active (деактивация счета - use-case 7)
- Отсутствует связь с транзакциями

Необходимые изменения:
- Добавить поле is_active: Boolean
- Поле balance переименовать в start_balance и использовать только для начального остатка
- Текущий баланс рассчитывается через транзакции и отдельно хранить данные не требуется

### 2. Entity: OperationalTransactionEntity
Требует существенной доработки для покрытия use-case:
- Отсутствует поле account_id (связь со счетом)
- Поле transaction_type использует строку, а не enum
- Поле category использует строку, нужна связь с справочником
- Отсутствует поле status для отслеживания отмены операции
- Отсутствует поле comment для автоматических комментариев
- Отсутствует поле related_transaction_id для связи парных операций переводов
- currency по умолчанию USD, а должно быть RUB или браться со счета

Необходимые изменения:
- Добавить account_id: Integer, ForeignKey (обязательное)
- Изменить transaction_type на использование enum TransactionType
- Изменить category на category_id: Integer, ForeignKey (nullable, связь со справочником категорий)
- Добавить поле status: TransactionStatus enum
- Добавить поле comment: String (для автоматических комментариев при переводах)
- Добавить поле related_transaction_id: Integer, ForeignKey (nullable, для связи парных переводов)
- Изменить currency по умолчанию на RUB

### 3. Entity: OperationalCategoryEntity (создать новую)
Справочник категорий транзакций для группировки и аналитики:
- name: String (обязательное, название категории)
- description: String (nullable, описание)
- icon: String (nullable, иконка для UI)
- color: String (nullable, цвет для UI)
- is_system: Boolean (признак системной категории, не удаляемой пользователем)

Наследует BaseEntity (id, created_at, updated_at, is_deleted)

### 4. Entity: OperationalCategoryTreeEntity (создать новую)
Иерархическая структура категорий (родитель-потомок):
- parent_category_id: Integer, ForeignKey (nullable, родительская категория)
- child_category_id: Integer, ForeignKey (обязательное, дочерняя категория)
- tree_type: Enum
- level: Integer (уровень вложенности)

Наследует BaseEntity

Примечание: если parent_category_id = null, значит это корневая категория

### 5. Enums

#### CategoryType (создать новый, опционально)
Типы категорий для быстрой фильтрации:
- INCOME_CATEGORY - категории доходов
- EXPENSE_CATEGORY - категории расходов
- BOTH - универсальные категории

#### TransactionType (достаточно)
Текущие: INCOME, EXPENSE
Примечание: TRANSFER не является отдельным типом транзакции. Перевод между счетами на UI создает две транзакции автоматически:
- EXPENSE со счета-источника с comment "Перевод на счет {название}"
- INCOME на счет-получатель с comment "Перевод со счета {название}"

#### TransactionStatus (создать новый)
Статусы операции:
- ACTIVE - активная операция
- CANCELLED - отмененная операция
- PENDING - ожидающая подтверждения (опционально)

#### AccountType (достаточно)
Текущих значений достаточно для базовой функциональности.

### 6. Domain Models

Для модуля finance необходимо создать доменные модели:

#### OperationalFinanceAccount (Domain Model)
Представление счета на уровне бизнес-логики:
- id: int
- name: str
- account_number: str | None
- account_type: OperationalAccountType
- currency: str
- start_balance: Decimal
- is_active: bool
- created_at: datetime
- updated_at: datetime
- is_deleted: bool
- text_color: str | None
- bg_color: str | None
- sort_position: int | None

Методы:
- is_available_for_transaction() -> bool
- deactivate() -> None

#### OperationalFinanceTransaction (Domain Model)
Представление транзакции на уровне бизнес-логики:
- id: int
- account_id: int
- transaction_number: str
- transaction_type: OperationalTransactionType
- status: OperationalTransactionStatus
- amount: Decimal
- currency: str
- description: str | None
- comment: str | None
- category_id: int | None
- transaction_date: date
- related_transaction_id: int | None
- order_id: int | None
- movement_id: int | None
- created_at: datetime
- updated_at: datetime
- is_deleted: bool
- text_color: str | None
- bg_color: str | None
- sort_position: int | None

Методы:
- cancel() -> None
- is_cancelled() -> bool
- is_transfer() -> bool

#### OperationalTransactionCategory (Domain Model)
Представление категории транзакций:
- id: int
- name: str
- description: str | None
- icon: str | None
- color: str | None
- is_system: bool
- created_at: datetime
- updated_at: datetime
- is_deleted: bool
- text_color: str | None
- bg_color: str | None
- sort_position: int | None

#### OperationalTransactionCategoryTree (Domain Model)
Представление иерархии категорий:
- id: int
- parent_category_id: int | None
- child_category_id: int
- level: int
- created_at: datetime
- updated_at: datetime
- is_deleted: bool
- text_color: str | None
- bg_color: str | None
- sort_position: int | None

### 7. Pydantic Schemas

#### AccountBase
Базовая схема для счета:
- name: str
- details: str | None
- account_number: str | None
- account_type: AccountType
- currency: str
- initial_balance: Decimal

#### AccountCreate
Для создания счета (use-case 5):
Наследует AccountBase

#### AccountUpdate
Для редактирования счета (use-case 6):
Все поля опциональны из AccountBase

#### AccountResponse
Для ответа API:
Все поля из AccountBase плюс:
- id: int
- is_active: bool
- current_balance: Decimal
- created_at: datetime
- updated_at: datetime

#### AccountListResponse
Список счетов (use-case 10):
- accounts: list[AccountResponse]
- total: int

#### TransactionBase
Базовая схема для транзакции:
- transaction_type: TransactionType
- amount: Decimal
- currency: str
- description: str | None
- category_id: int | None
- transaction_date: date
- account_id: int

#### TransactionCreate
Для создания транзакции (use-case 1):
Наследует TransactionBase

#### TransferCreate
Для UI перевода между счетами (use-case 1):
- amount: Decimal
- currency: str
- description: str | None
- transaction_date: date
- source_account_id: int
- destination_account_id: int
Примечание: создает две транзакции автоматически

#### TransactionResponse
Для ответа API:
Все поля из TransactionBase плюс:
- id: int
- transaction_number: str
- status: TransactionStatus
- related_transaction_id: int | None
- created_at: datetime
- updated_at: datetime

#### TransactionListResponse
Для истории операций (use-case 3):
- transactions: list[TransactionResponse]
- total: int

#### AccountBalanceResponse
Для баланса счета (use-case 2):
- account_id: int
- account_name: str
- balance: Decimal
- currency: str
- balance_date: date

#### AccountStatementRequest
Для выписки по счету (use-case 8):
- account_id: int
- date_from: date
- date_to: date
- format: str (CSV, EXCEL, PDF)

#### AccountStatementResponse
- account: AccountResponse
- transactions: list[TransactionResponse]
- opening_balance: Decimal
- closing_balance: Decimal
- total_income: Decimal
- total_expense: Decimal
- date_from: date
- date_to: date

#### AccountReconciliationRequest
Для сверки остатков (use-case 9):
- account_ids: list[int]
- date: date

#### AccountReconciliationResponse
- reconciliation_date: date
- accounts: list[dict]  # account_id, name, balance
- total_balance: Decimal

#### CategoryBase
Базовая схема для категории:
- name: str
- description: str | None
- icon: str | None
- text_color: str | None
- bg_color: str | None

#### CategoryCreate
Для создания категории:
Наследует CategoryBase плюс:
- parent_category_id: int | None

#### CategoryUpdate
Для редактирования категории:
Все поля опциональны из CategoryBase плюс:
- parent_category_id: int | None

#### CategoryResponse
Для ответа API:
Все поля из CategoryBase плюс:
- id: int
- is_system: bool
- parent_category_id: int | None
- level: int
- full_path: str
- created_at: datetime
- updated_at: datetime

#### CategoryTreeResponse
Для отображения дерева категорий:
- category: CategoryResponse
- children: list[CategoryTreeResponse]

#### CategoryListResponse
Список категорий:
- categories: list[CategoryResponse]
- total: int

## Приоритет реализации

1. Создать Entity: OperationalCategoryEntity, OperationalCategoryTreeEntity
2. Доработать Entity: OperationalAccountEntity (is_active, start_balance)
3. Доработать Entity: OperationalTransactionEntity (account_id, category_id, status, comment, related_transaction_id)
4. Создать Enums: OperationalTransactionStatus, CategoryType (опционально)
5. Создать Domain Models: OperationalFinanceAccount, OperationalFinanceTransaction, OperationalTransactionCategory
6. Создать все Pydantic Schemas (Account, Transaction, Category)
7. Реализовать Repository и Service слои

## Соответствие архитектуре

Согласно документу "Архитектура контекстов":
- OperationalFinanceAccount = OperationalAccountEntity + OperationalFinanceAccount (domain model)
- OperationalFinanceTransaction = OperationalTransactionEntity + OperationalFinanceTransaction (domain model)
- Данные операционного уровня используются для генерации бухгалтерских проводок
- Поток данных: Операционный → Бухгалтерский (однонаправленный)

## Дополнительные замечания

1. Номер транзакции (transaction_number) должен быть инкрементом и генерироваться автоматически
2. Перевод между счетами (TRANSFER) создает две связанные транзакции с автоматическими комментариями (комментарий пишется программно)
3. Связь парных транзакций осуществляется через поле related_transaction_id
4. При отмене одной транзакции из пары перевода - отменяется и вторая автоматически
5. Валидация движения денег должна проверять совпадение валют счета и транзакции
6. При переводе между счетами в разных валютах выдавать пользователю ошибку на UI. 
7. Баланс счета рассчитывается динамически: start_balance + сумма INCOME - сумма EXPENSE (только ACTIVE транзакции)
8. Мягкое удаление используется через поле is_deleted из BaseEntity
9. При отмене транзакции изменяется status, а не is_deleted
10. Поле comment используется для автоматических комментариев (переводы, системные операции)
