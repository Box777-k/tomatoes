ЛОГИКА ГЕНЕРАЦИИ БУХГАЛТЕРСКИХ ПРОВОДОК ИЗ ОПЕРАЦИОННОГО УЧЕТА

ОБЩИЙ ПРИНЦИП:
Операционный уровень → Автоматическая генерация проводок (черновик) → Проверка бухгалтером → Закрытие периода

ЭТАПЫ ОБРАБОТКИ:

1. Создание операционной транзакции
   - Пользователь создает операцию в операционном учете (приход/расход/перемещение)
   - Система ищет подходящее правило маппинга по условиям:
     * Тип операционного счета (банк/касса/кошелек)
     * Тип транзакции (приход/расход/перемещение)
     * Категория операции (если указана)
   - Автоматически создаются бухгалтерские проводки в статусе "черновик"
   - Одна операция может породить несколько проводок

2. Изменение операционных данных
   - При изменении операции пересматриваются все связанные проводки
   - Черновики проводок пересоздаются заново по актуальным правилам
   - Утвержденные проводки (после закрытия периода) не пересоздаются

3. Закрытие периода
   - Бухгалтер просматривает все проводки в статусе "черновик" за период
   - Проверяет корректность проводок
   - При необходимости корректирует вручную или меняет правила маппинга
   - Закрывает период - все проводки переходят в статус "утверждено"
   - После закрытия периода проводки нельзя изменить без специальных прав

ПРАВИЛА МАППИНГА (AccountingMapping):

Структура правила:
- Условия срабатывания:
  * operational_account_type (тип счета: CASH/NON_CASH)
  * transaction_type (тип операции: INCOME/EXPENSE/TRANSFER)
  * category_id (категория операции, nullable)
- Шаблон проводок:
  * debit_account_id (счет дебета по плану счетов)
  * credit_account_id (счет кредита по плану счетов)
  * amount_formula (формула расчета суммы, по умолчанию = сумма операции)
- Приоритет (если несколько правил подходят)
- Активность (можно отключить правило)

Примеры правил:
1. Поступление на безналичный счет от покупателя:
   - Условия: account_type=NON_CASH, transaction_type=INCOME, category="Оплата от покупателя"
   - Проводка: Дт 51 "Расчетный счет" Кт 62 "Расчеты с покупателями"

2. Расход наличных на закупку материалов:
   - Условия: account_type=CASH, transaction_type=EXPENSE, category="Закупка материалов"
   - Проводка 1: Дт 10 "Материалы" Кт 50 "Касса"
   - Проводка 2: Дт 19 "НДС" Кт 50 "Касса" (если есть НДС)

3. Перемещение между счетами:
   - Условия: transaction_type=TRANSFER
   - Проводка: Дт "Счет-получатель" Кт "Счет-источник"

4. Инкассация (перемещение наличных на безналичный):
   - Условия: transaction_type=TRANSFER, from_account_type=CASH, to_account_type=NON_CASH
   - Проводка: Дт 51 "Расчетный счет" Кт 50 "Касса"

СТАТУСЫ ПРОВОДОК:

- DRAFT (черновик) - создана автоматически, можно пересоздать
- APPROVED (утверждено) - закрыт период, нельзя изменить
- MANUAL (ручная) - создана бухгалтером напрямую, не привязана к операции

ОСОБЕННОСТИ:

- Если правило маппинга не найдено - создается проводка со статусом "требует проверки"
- Бухгалтер может создавать проводки вручную без операционной транзакции
- При отмене операционной транзакции проводки не удаляются, а создается сторнирующая проводка
- История изменений правил маппинга сохраняется для аудита
